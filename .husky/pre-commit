# =====================================================================
# Husky pre-commit hook (BE ì „ìš© ë ˆí¬)
# - BE: Docker(Compose) ì»¨í…Œì´ë„ˆì—ì„œ Maven ì •ì ë¶„ì„(Checkstyle/PMD)
# =====================================================================

set -euo pipefail

# --------------------------- Helpers ---------------------------------
log()   { printf "\033[36m%s\033[0m\n" "$*"; }
ok()    { printf "âœ… \033[32m%s\033[0m\n" "$*"; }
warn()  { printf "âš ï¸  \033[33m%s\033[0m\n" "$*"; }
fail()  { printf "âŒ \033[31m%s\033[0m\n" "$*" >&2; exit 1; }
error() { printf "âŒ \033[31m%s\033[0m\n" "$*" >&2; }
divider(){ printf "\n\033[35mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n\n"; }

# (ìˆ˜ì •ë¨) í•­ìƒ í”„ë¡œì íŠ¸ ë£¨íŠ¸(HMM)ì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

divider
log "ğŸš€ Husky pre-commit Hook ì‹œì‘ (Backend)"

# --------------- BE Static Analysis (Docker) -------------------------
divider
log "ğŸ›  [Step 1] Java ì •ì ë¶„ì„ (Maven in Docker: Checkstyle/PMD)"

command -v docker >/dev/null 2>&1 || fail "Dockerê°€ í•„ìš”í•©ë‹ˆë‹¤."
docker compose version >/dev/null 2>&1 || fail "Docker Composeê°€ í•„ìš”í•©ë‹ˆë‹¤."

COMPOSE_FILE="infra/docker-compose.yml"
[ -f "$COMPOSE_FILE" ] || fail "compose íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ($COMPOSE_FILE ê²½ë¡œ í™•ì¸)"
docker compose -f "$COMPOSE_FILE" config >/dev/null || fail "compose êµ¬ì„± ì˜¤ë¥˜"

# (ìˆ˜ì •ë¨) ë£¨íŠ¸ ê¸°ì¤€ì—ì„œ pom.xml í™•ì¸
if [ -f "pom.xml" ]; then
  # (ìˆ˜ì •ë¨) ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ì •í™•í•œ pom.xml ê²½ë¡œ(-f)ë¥¼ ì§€ì •
  if ! docker compose -f "$COMPOSE_FILE" run --rm --remove-orphans -T code-quality \
        bash -lc 'mvn -f /workspace/pom.xml -q -DskipTests \
          -Dcheckstyle.skip=false -Dpmd.skip=false \
          clean verify'
  then
    error "Java ì •ì ë¶„ì„ ì‹¤íŒ¨ â†’ ì»¤ë°‹ ì°¨ë‹¨"
    echo "â”€â”€â”€ PMD ìš”ì•½ â”€â”€â”€"
    # (ìˆ˜ì •ë¨) ë£¨íŠ¸ ê¸°ì¤€ì—ì„œ pmd-summary.sh ê²½ë¡œ
    PMD_SUMMARY_LIMIT=100 ./scripts/pmd-summary.sh || true
    echo "ğŸ“„ ìƒì„¸: target/site/pmd.html ë˜ëŠ” target/pmd.xml"
    exit 1
  fi
else
  warn "pom.xmlì„ ì°¾ì§€ ëª»í•´ Java ì •ì ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤."
fi

divider
ok "ğŸ‰ğŸ‰ğŸ‰ [pre-commit] ëª¨ë“  ê²€ì‚¬ í†µê³¼ ğŸ‰ğŸ‰ğŸ‰"
divider