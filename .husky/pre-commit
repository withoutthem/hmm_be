# =====================================================================
# Husky pre-commit hook (BE ì „ìš© ë ˆí¬)
# - BE: Docker(Compose) ì»¨í…Œì´ë„ˆì—ì„œ Maven í¬ë§·/ì •ì ë¶„ì„
#   1) Spotless(ìë™ìˆ˜ì •) â†’ 2) Checkstyle/PMD(ê²€ì¦)
# =====================================================================

set -euo pipefail

# --------------------------- Helpers ---------------------------------
log()   { printf "\033[36m%s\033[0m\n" "$*"; }
ok()    { printf "âœ… \033[32m%s\033[0m\n" "$*"; }
warn()  { printf "âš ï¸  \033[33m%s\033[0m\n" "$*"; }
fail()  { printf "âŒ \033[31m%s\033[0m\n" "$*" >&2; exit 1; }
divider(){ printf "\n\033[35mâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\033[0m\n\n"; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
cd "$REPO_ROOT"

divider
log "ğŸš€ Husky pre-commit Hook ì‹œì‘ (Backend)"

# 0) ìŠ¤í…Œì´ì§€ ëŒ€ìƒì— Java/POM ë³€ê²½ì´ ì—†ìœ¼ë©´ ê±´ë„ˆëœ€
CHANGED="$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^(backend/|pom\.xml$|^src/|^configuration/).*' || true)"
if [ -z "$CHANGED" ]; then
  warn "ìŠ¤í…Œì´ì§€ëœ Java/Maven ê´€ë ¨ ë³€ê²½ì´ ì—†ì–´ ê²€ì¦ì„ ê±´ë„ˆëœë‹ˆë‹¤."
  ok   "ë¹ ë¥¸ í†µê³¼"
  divider
  exit 0
fi

# 1) Docker / Compose ì ê²€
command -v docker >/dev/null 2>&1 || fail "Dockerê°€ í•„ìš”í•©ë‹ˆë‹¤."
docker compose version >/dev/null 2>&1 || fail "Docker Composeê°€ í•„ìš”í•©ë‹ˆë‹¤."

COMPOSE_FILE="infra/docker-compose.yml"
[ -f "$COMPOSE_FILE" ] || fail "compose íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $COMPOSE_FILE"
docker compose -f "$COMPOSE_FILE" config >/dev/null || fail "compose êµ¬ì„± ì˜¤ë¥˜"

# 2) Spotless: ìë™ í¬ë§· (validateì— ë°”ì¸ë”©ë˜ì–´ ìˆìœ¼ë‚˜, ëª…ì‹œì ìœ¼ë¡œë„ í•œë²ˆ ì‹¤í–‰)
divider
log "ğŸ§¹ [Step 1] Java ìë™ìˆ˜ì • (Spotless apply)"
docker compose -f "$COMPOSE_FILE" run --rm --remove-orphans -T code-quality \
  bash -lc 'mvn -f /workspace/pom.xml -DskipTests spotless:apply' \
  || fail "Spotless ì ìš© ì‹¤íŒ¨"

# 3) Checkstyle / PMD: ê²€ì¦
divider
log "ğŸ›¡ [Step 2] Checkstyle / PMD ê²€ì¦"
if ! docker compose -f "$COMPOSE_FILE" run --rm --remove-orphans -T code-quality \
        bash -lc 'mvn -f /workspace/pom.xml -DskipTests -Dcheckstyle.skip=false -Dpmd.skip=false clean verify'
then
  printf "\n"
  warn "ì •ì ë¶„ì„ ì‹¤íŒ¨ ìš”ì•½ (PMD)"
  if [ -x "./scripts/pmd-summary.sh" ]; then
    PMD_SUMMARY_LIMIT=120 ./scripts/pmd-summary.sh || true
  else
    warn "pmd-summary.shê°€ ì—†ì–´ ìš”ì•½ì„ ìƒëµí•©ë‹ˆë‹¤."
  fi
  warn "ğŸ“„ ìƒì„¸ ë¦¬í¬íŠ¸: backend/target/site/pmd.html, backend/target/pmd.xml"
  fail "Java ì •ì ë¶„ì„ ì‹¤íŒ¨ â†’ ì»¤ë°‹ ì°¨ë‹¨"
fi

divider
ok "ğŸ‰ğŸ‰ğŸ‰ [pre-commit] ëª¨ë“  ê²€ì‚¬ í†µê³¼ ğŸ‰ğŸ‰ğŸ‰"
divider