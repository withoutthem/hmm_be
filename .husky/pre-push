#!/usr/bin/env bash
# =====================================================================
# Husky pre-push hook (BE ì „ìš© ë ˆí¬)
# - BE: -P dev ê°•ì œ, JDK 17ì„ ë¦¬í¬/ë¡œì»¬ì—ì„œ ì°¾ì•„ ì„ì‹œ JAVA_HOME ì„¤ì •
# =====================================================================

. "$(dirname "$0")/husky.sh"
set -euo pipefail

# --------------------------- Helpers ---------------------------------
CYN='\033[36m'; GRN='\033[32m'; YLW='\033[33m'; RED='\033[31m'; MAG='\033[35m'; NC='\033[0m'
log()   { printf "${CYN}%s${NC}\n" "$*"; }
ok()    { printf "âœ… ${GRN}%s${NC}\n" "$*"; }
warn()  { printf "âš ï¸  ${YLW}%s${NC}\n" "$*"; }
fail()  { printf "âŒ ${RED}%s${NC}\n" "$*" >&2; exit 1; }
# shellcheck disable=SC2059
divider(){ printf "\n${MAG}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}\n\n"; }

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

divider
log "ğŸš€ pre-push ì‹œì‘: Backend ê°œë°œ ë¹Œë“œ ê²€ì¦"

# ------------------------ BE: dev + ë‚´ë¶€ JDK17 ------------------------
divider
log "ğŸ— [Step 1] Backend ê°œë°œ ë¹Œë“œ (-P dev, ë‚´ë¶€ JDK 17 ìš°ì„ )"

[ -f "pom.xml" ] || fail "pom.xml ì´ ì—†ìŠµë‹ˆë‹¤."

# 1) mvnw ì„ íƒ (ë£¨íŠ¸ mvnw > ì‹œìŠ¤í…œ mvn)
if [ -f "./mvnw" ]; then
  MVN="sh ./mvnw"
elif command -v mvn >/dev/null 2>&1; then
  MVN="mvn"
else
  fail "Maven ì‹¤í–‰ê¸°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (./mvnw ë˜ëŠ” mvn í•„ìš”)"
fi

# 2) JDK17 íƒìƒ‰
detect_jdk17() {
  for CAND in "./.mvn/jdk-17" "./.jdk17"; do
    [ -x "$CAND/bin/java" ] && echo "$CAND" && return 0
  done
  if command -v /usr/libexec/java_home >/dev/null 2>&1; then
    JH="$(/usr/libexec/java_home -v 17 2>/dev/null || true)"
    [ -n "${JH:-}" ] && [ -x "$JH/bin/java" ] && echo "$JH" && return 0
  fi
  for CAND in "/usr/lib/jvm/temurin-17"* "/usr/lib/jvm/java-17-"* "/opt/jdk-17"*; do
    [ -x "$CAND/bin/java" ] && echo "$CAND" && return 0
  done
  return 1
}

JAVA_17_HOME=""
if JAVA_17_HOME="$(detect_jdk17)"; then
  log "ğŸ”§ JDK17 ì‚¬ìš©: $JAVA_17_HOME"
  export JAVA_HOME="$JAVA_17_HOME"
  export PATH="$JAVA_HOME/bin:$PATH"
else
  warn "JDK 17ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í˜„ì¬ Javaë¡œ ë¹Œë“œ(ì˜¤ë¥˜ ê°€ëŠ¥) â†’ ë¦¬í¬ ë‚´ë¶€ì— JDK17ì„ ë‘ë©´ ìë™ ì‚¬ìš©ë©ë‹ˆë‹¤."
fi

# 3) ë¹Œë“œ ì‹¤í–‰
BE_CMD="$MVN -q clean package -DskipTests -P dev"
log "ğŸ— ì‹¤í–‰: ${BE_CMD}"
sh -c "${BE_CMD}" || fail "Backend ê°œë°œ ë¹Œë“œ ì‹¤íŒ¨ â†’ push ì¤‘ë‹¨"

ok "Backend ê°œë°œ ë¹Œë“œ í†µê³¼"
divider
ok "ğŸ‰ğŸ‰ğŸ‰ [pre-push] BE ëª¨ë“  ë¹Œë“œ í†µê³¼(dev) ğŸ‰ğŸ‰ğŸ‰ â†’ push ì§„í–‰"